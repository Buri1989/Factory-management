<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta http-equiv="X-UA-Compatible" content="IE=edge" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <link
      href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0-alpha1/dist/css/bootstrap.min.css"
      rel="stylesheet"
      integrity="sha384-GLhlTQ8iRABdZLl6O3oVMWSktQOp6b7In1Zl3/Jr59b6EGGoI1aFkw7cmDA6j6gD"
      crossorigin="anonymous"
    />
    <title>Employees</title>
  </head>
  <body onload="getAllEmployees()">
    <div class="container" style="margin-top: 50px">
      <button type="button" class="btn btn-dark" onclick="addNewEmployee()">
        Add New Employee
      </button>
      <br /><br /><br />

      <select id="departmentsDrop" oninput="filterEmployeeTable()"></select>
      <br /><br /><br />

      <table class="table table-striped table-bordered" id="departmentTable">
        <thead>
          <tr>
            <th scope="col">Full name</th>
            <th scope="col">Department</th>
            <th scope="col">Shifts</th>
          </tr>
        </thead>
        <tbody id="tBody"></tbody>
      </table>
    </div>
    <script>
      const urlEmployees = "http://localhost:8000/employees";
      const urlDepartments = "http://localhost:8000/departments";
      const urlShifts = "http://localhost:8000/shifts";

      async function getAllEmployees() {
        const responseEmployee = await fetch(urlEmployees);
        const employees = await responseEmployee.json();

        const responseDepartment = await fetch(urlDepartments);
        const departments = await responseDepartment.json();

        const responseShift = await fetch(urlShifts);
        const shifts = await responseShift.json();

        const tBody = document.getElementById("tBody");

        employees.forEach((employee) => {
          /*table row */
          const tr = document.createElement("tr");

          /*'Full name' col*/
          const tdName = document.createElement("td");
          const nameLink = document.createElement("a");

          nameLink.href = `editEmployee.html?employeeId=${employee._id}`;

          nameLink.innerHTML = employee.firstName + " " + employee.lastName;
          tdName.appendChild(nameLink);

          /*'Department' col*/
          const tdDepartment = document.createElement("td");
          const departmentLink = document.createElement("a");

          const department = departments.find(
            (dep) => d._id === employee.departmentId.toString()
          );
          departmentLink.href = `editDepartment.html?departmentId=${department._id}`;
          departmentLink.innerHTML = department.name;
          tdDepartment.appendChild(department);

          /*'Shifts' col*/
          const shift = shifts.find(
            (sh) => s.shiftNumber === employee.shifts[0].shiftNumber
          );
          const tdShift = document.createElement("td");
          tdShift.innerHTML =
            shift.startingHour +
            " " +
            shift.endingHour +
            " " +
            shift.data.slice(0, 10);

          tr.appendChild(tdName);
          tr.appendChild(tdDepartment);
          tr.addNewEmployee(tdShift);

          tBody.appendChild(tr);
        });

        /* Blank option*/
        const dropDown = document.getElementById("departmentsDrop");
        const blankOption = document.createElement("option");
        blankOption.innerHTML = "All";
        dropdown.appendChild(blankOption);

        /*'Departments' dropdown*/
        departments.map((department) => {
          const option = document.createElement("option");
          option.innerHTML = department.name;
          option.id = department.name + "Dep";
          dropdown.appendChild(option);
        });
      }

      function filterEmployeeTable() {
        const dropDown = document.getElementById("departmentsDropdown");
        const table = document.getElementById("departmentTable");
        const rows = table.getElementsByTagName("tr");
        const filter = dropDown.value;

        for (let row of rows) {
          const cells = row.getElementsByTagName("td");
          const department = cells[1] || null;
          if (
            filter === "All" ||
            !department ||
            filter === department.textContent
          ) {
            row.style.display = "";
          } else {
            row.style.display = "none";
          }
        }
      }

      function addNewEmployee() {
        location.href = "addNewEmployee.html"; // sets the URL of the current page
      }
    </script>
  </body>
</html>
